# ğŸ–¥ï¸ App ç®¡ç†æ¶æ„è®¾è®¡

> è®¾è®¡ç›®æ ‡ï¼šè®© AI å’Œç”¨æˆ·èƒ½å¤ŸååŒæ“ä½œ"è™šæ‹Ÿç³»ç»Ÿ"ä¸­çš„å„ç§ Appï¼ˆæµè§ˆå™¨ã€ç¼–è¾‘å™¨ç­‰ï¼‰

---

## ğŸ“‹ æ ¸å¿ƒæ¦‚å¿µ

| æ¦‚å¿µ | è¯´æ˜ |
|-----|------|
| **App** | ä¸€ä¸ªç‹¬ç«‹çš„åŠŸèƒ½å•å…ƒï¼ˆæµè§ˆå™¨ã€ç¼–è¾‘å™¨ç­‰ï¼‰ |
| **AppManager** | åç«¯æ ¸å¿ƒï¼Œç®¡ç†æ‰€æœ‰ App çš„ç”Ÿå‘½å‘¨æœŸ |
| **App è½¯ä»¶åŒ…** | `server/apps/` ä¸‹çš„æ–‡ä»¶å¤¹ï¼ŒåŒ…å«åç«¯é€»è¾‘å’Œå‰ç«¯ç»„ä»¶ |

---

## ğŸ—ï¸ åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         AI Agent                             â”‚
â”‚  (è°ƒç”¨ AppManager APIï¼Œæ§åˆ¶æ‰€æœ‰ App)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    AppManager (åç«¯)                         â”‚
â”‚  - è¯»å– server/apps/ ç›®å½•                                   â”‚
â”‚  - ç®¡ç† App ç”Ÿå‘½å‘¨æœŸ (launch/close)                         â”‚
â”‚  - åˆ†å‘æ“ä½œ (dispatch)                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       é€šä¿¡å±‚                                 â”‚
â”‚  å‰ç«¯â†’åç«¯: crossFuncs + settingData.fnCall                 â”‚
â”‚  åç«¯â†’å‰ç«¯: ioServer (socket.emit)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    å‰ç«¯ GUI å“åº”å™¨                           â”‚
â”‚  - åŠ¨æ€åŠ è½½ App å‰ç«¯æ¨¡å—                                    â”‚
â”‚  - Notice.launch æ˜¾ç¤º App çª—å£                              â”‚
â”‚  - æ¡Œé¢/èœå•æ å…¥å£                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ App è½¯ä»¶åŒ…ç»“æ„

```
server/apps/
â”œâ”€â”€ browser/
â”‚   â”œâ”€â”€ app.json          # App æè¿°æ–‡ä»¶
â”‚   â”œâ”€â”€ backend.js        # åç«¯é€»è¾‘
â”‚   â””â”€â”€ frontend.js       # å‰ç«¯ç»„ä»¶ (ES6 æ¨¡å—)
â”œâ”€â”€ editor/
â”‚   â”œâ”€â”€ app.json
â”‚   â”œâ”€â”€ backend.js
â”‚   â””â”€â”€ frontend.js
â””â”€â”€ [custom-app]/         # AI æˆ–ç”¨æˆ·åˆ›å»ºçš„ App
    â””â”€â”€ ...
```

### app.json ç¤ºä¾‹

```json
{
  "id": "browser",
  "name": "æµè§ˆå™¨",
  "icon": "ğŸŒ",
  "version": "1.0.0",
  "description": "å†…ç½®æµè§ˆå™¨ï¼Œæ”¯æŒ AI ååŒæ“ä½œ",
  "backend": "./backend.js",
  "frontend": "./frontend.js"
}
```

---

## ğŸ”„ å‰ç«¯åŠ¨æ€åŠ è½½æœºåˆ¶

### æ ¸å¿ƒæ€è·¯

1. **main.js å¯¼å‡ºå…¬å…±ä¾èµ–**ï¼šç¼–è¯‘åçš„å‰ç«¯å…¥å£å¯¼å‡º `m`, `Notice`, `socket` ç­‰
2. **App frontend.js è¿è¡Œæ—¶åŠ è½½**ï¼šé€šè¿‡ HTTP URL import
3. **frontend.js å¯ä»¥ import main.js**ï¼šè·å–å…¬å…±ç»„ä»¶å’Œä¾èµ–

### è·¯ç”±é…ç½®

| è·¯ç”± | è¯´æ˜ |
|-----|------|
| `/dist/main.js` | ç¼–è¯‘åçš„å‰ç«¯å…¥å£ï¼ˆå¯¼å‡ºå…¬å…±ä¾èµ–ï¼‰ |
| `/api/apps/:appId/frontend.js` | App çš„å‰ç«¯æ¨¡å— |

### frontend.js ç¤ºä¾‹

```javascript
// server/apps/browser/frontend.js
import { m, Notice, socket } from "/dist/main.js"

export default {
  view: ({ attrs }) => {
    return m("div", { style: { width: "100%", height: "100%" } }, [
      m("webview", { src: attrs.data.url, style: { width: "100%", height: "100%" } })
    ])
  }
}
```

---

## ğŸ”§ AppManager æ ¸å¿ƒ API

```javascript
// server/apps/AppManager.js

class AppManager {
  constructor() {
    this.apps = new Map()        // appId -> appInstance
    this.appDefs = new Map()    // type -> appDefinition
  }

  // è¯»å– apps ç›®å½•ï¼Œæ³¨å†Œæ‰€æœ‰ App ç±»å‹
  async init() { ... }

  // å¯åŠ¨ App
  async launch(type, options = {}) { return appId }

  // å…³é—­ App
  close(appId) { return boolean }

  // è°ƒç”¨ App æ“ä½œï¼ˆè½¬å‘åˆ°å‰ç«¯æ‰§è¡Œï¼‰
  async dispatch(appId, action, args = {}) { return result }

  // è·å–æ‰€æœ‰ App æ¦‚è¦ï¼ˆä¾› AI æŸ¥è¯¢ï¼‰
  getSummary() { return [{ id, type, state, ... }] }

  // è·å– App ç±»å‹åˆ—è¡¨ï¼ˆä¾›å‰ç«¯æ¡Œé¢æ˜¾ç¤ºï¼‰
  getappDefs() { return [{ id, name, icon, ... }] }
}

export default new AppManager()
```

---

## ğŸ–±ï¸ ç”¨æˆ·å¯åŠ¨ App æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»èœå•æ "æ¡Œé¢"æŒ‰é’®
    â†“
å¼¹çª—æ˜¾ç¤º App ç½‘æ ¼åˆ—è¡¨ï¼ˆå›¾æ ‡ + åç§°ï¼‰
    â†“
ç”¨æˆ·ç‚¹å‡»å›¾æ ‡
    â†“
settingData.fnCall("appLaunch", { type: "browser" })  // crossFuncs è°ƒç”¨åç«¯
    â†“
åç«¯ AppManager.launch("browser")
    â†“
io.emit("app:launch", { appId, type, frontendUrl, data })  // åç«¯é€šçŸ¥å‰ç«¯
    â†“
å‰ç«¯åŠ¨æ€ import(frontendUrl)
    â†“
frontend.js åŠ è½½ â†’ import "/dist/main.js" è·å–ä¾èµ–
    â†“
Notice.launch({ sign: appId, content: module.default })
```

---

## ğŸ¤– AI å¯åŠ¨ App æµç¨‹

```
AI è°ƒç”¨ appLaunch({ type: "editor", data: { filePath: "..." } })
    â†“
åç«¯ AppManager.launch("editor", { data })
    â†“
(åŒä¸Šæµç¨‹)
```

---

## ğŸ“± å†…ç½® App ç±»å‹

### Browser (æµè§ˆå™¨)

**ç”¨é€”**ï¼šç”¨æˆ·å’Œ AI ååŒæµè§ˆç½‘é¡µ

**dispatch æ“ä½œ**ï¼š
| æ“ä½œ | è¯´æ˜ | å‚æ•° |
|-----|------|------|
| navigate | å¯¼èˆªåˆ° URL | url |
| getContent | è·å–é¡µé¢æ–‡æœ¬ | - |
| getHTML | è·å–é¡µé¢ HTML | - |
| executeJS | æ‰§è¡Œ JS ä»£ç  | code |
| click | ç‚¹å‡»å…ƒç´  | selector |
| type | è¾“å…¥æ–‡æœ¬ | selector, text |
| screenshot | æˆªå›¾ | - |

---

### Editor (ç¼–è¾‘å™¨)

**ç”¨é€”**ï¼šä»£ç ç¼–è¾‘ï¼ŒAI ä¿®æ”¹ä»£ç æ—¶æ˜¾ç¤º diff

**dispatch æ“ä½œ**ï¼š
| æ“ä½œ | è¯´æ˜ | å‚æ•° |
|-----|------|------|
| open | æ‰“å¼€æ–‡ä»¶ | filePath |
| save | ä¿å­˜æ–‡ä»¶ | - |
| getContent | è·å–å†…å®¹ | - |
| setContent | è®¾ç½®å†…å®¹ | content |
| showDiff | æ˜¾ç¤ºå·®å¼‚ | original, proposed |
| applyDiff | åº”ç”¨å·®å¼‚ | - |
| rejectDiff | æ‹’ç»å·®å¼‚ | - |

---

## ğŸš€ å®ç°ä¼˜å…ˆçº§

1. **AppManager æ ¸å¿ƒ** - ç”Ÿå‘½å‘¨æœŸç®¡ç†
2. **å‰ç«¯åŠ¨æ€åŠ è½½æœºåˆ¶** - main.js å¯¼å‡º + è·¯ç”±
3. **æ¡Œé¢å…¥å£** - èœå•æ æŒ‰é’® + App ç½‘æ ¼å¼¹çª—
4. **Browser App** - webview å°è£…
5. **Editor App** - Monaco Editor å°è£…
6. **AI è‡ªå®šä¹‰ App** - è®© AI èƒ½å¼€å‘æ–° App

---

## âš™ï¸ ç¼–ç è§„èŒƒ

### é€šä¿¡æ¨¡å¼

| æ–¹å‘ | æ–¹å¼ |
|-----|------|
| **å‰ç«¯ â†’ åç«¯** | `crossFuncs` + `settingData.fnCall` |
| **åç«¯ â†’ å‰ç«¯** | `ioServer` (socket.emit) |

### æ ·å¼è§„åˆ™

- **ç¦æ­¢ä½¿ç”¨ CSS ç±»**ï¼Œå…¨éƒ¨ä½¿ç”¨è¡Œå†… style
- ç¤ºä¾‹ï¼š`m("div", { style: { display: "flex", padding: "10px" } })`

### ç¼–ç¨‹é£æ ¼

- **ä¼˜å…ˆå‡½æ•°å¼ç¼–ç¨‹**ï¼Œä½†å¯ä»¥ä½¿ç”¨ classï¼ˆä¸ TSession ä¿æŒä¸€è‡´ï¼‰
- **å°½é‡å°‘åˆ›å»ºå˜é‡**ï¼Œé€šè¿‡åŠ¨ä½œé€»è¾‘ä»£æ›¿
- ä»£ç åº”èƒ½é€šè¿‡é˜…è¯»åŠ¨ä½œé€»è¾‘ç†è§£åœ¨åšä»€ä¹ˆ

### å‘½åè§„åˆ™

- éµå¾ªé¡¹ç›®ç°æœ‰å‘½åè§„åˆ™å’Œä»£ç é£æ ¼
- æ–‡ä»¶åï¼šå°é©¼å³° (å¦‚ `appManager.js`)
- å‡½æ•°åï¼šå°é©¼å³° (å¦‚ `launchApp`)
- å¸¸é‡ï¼šå¤§å†™ä¸‹åˆ’çº¿ (å¦‚ `MAX_APPS`)

---

## ğŸ“ ä¸ç°æœ‰ç³»ç»Ÿçš„å…³ç³»

| ç°æœ‰ç»„ä»¶ | å¤„ç†æ–¹å¼ |
|---------|---------|
| TSession (ç»ˆç«¯) | ä¿æŒä¸å˜ï¼Œæš‚ä¸è¿ç§»åˆ° AppManager |
| Notice.launch | ç»§ç»­ä½¿ç”¨ï¼Œä½œä¸º App çª—å£çš„å±•ç¤ºå±‚ |
| Browser.js | é‡æ„ä¸º App è½¯ä»¶åŒ…æ ¼å¼ |

---

*æœ€åæ›´æ–°: 2026-01-30*
